/*
 * HegraceMap.js
 * author daolin.shen
 * at 2016-08
 * */
var HegraceMap=function(){return{mapObj:null,infoWindow:null,markerJjrys:[],markerQjjls:[],alljjry:{},allqjjl:{},init:function(c,f){var b=this;this.mapObj=new AMap.Map("page-content",{level:17});if(c){var e=new Array();var d=c.split(";");$(d).each(function(g,h){e.push(h.split(","))});var a=new AMap.Polyline({path:e});a.setMap(this.mapObj)}$.get("getGwLngLats.htm",function(g){$(g.rows).each(function(j,k){var h=new AMap.Marker({icon:"media/image/"+k.img,position:k.dw.split(",")});h.setMap(b.mapObj)})});this.mapObj.setFitView();this.infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(0,-30)});this.getQjjlLngLatsInterval(f);this.getJjryLngLatsInterval(f)},getJjryLngLatsInterval:function(c){var a=this;var b=function(){$.get("getJjryLngLats.htm",function(e){if(a.markerJjrys.length>0){a.mapObj.remove(a.markerJjrys);a.markerJjrys=[]}a.alljjry={};var d=e.rows;$(d).each(function(g,j){var f=new AMap.Marker({icon:j.sbmc?"media/image/dsbjjy.png":"media/image/jjy.png",position:j.zb.split(",")});f.setMap(a.mapObj);f.on("click",function(k){var i="";$.get("getJjryInfomation.htm",{jjyid:j.id},function(l){var m=true;$.each(l.rows,function(n,o){if(n==0){i+="<div>急救员："+o.xm+"("+o.dh+")</div>";if(o.sbmc){i+="<div>设备名称："+o.sbmc+"</div>"}i+="<div>身份类型："+o.sflx+"</div>";i+="<div>类别："+o.lb+"</div>";i+="<br/>"}if(o.qjid){m=false;i+="<div>正在救助："+o.qjxm+"("+o.qjdh+")</div>"}});i+="<br/>";if(c=="1"&&m){i+=' <a href="javascript:;" class="btn red mini" onclick="HegraceMap.belaidOff(\''+j.id+"')\">下岗</a>"}a.infoWindow.setContent(i);a.infoWindow.open(a.mapObj,f.getPosition())})});var h=j.xm+"("+j.dh+")";if(j.sbmc){h+="<br/>设备:"+j.sbmc}f.setLabel({offset:new AMap.Pixel(30,0),content:h});a.alljjry[""+j.id]={marker:f,position:f.getPosition(),ryid:j.ryid,jlid:j.jlid,sbmc:j.sbmc,xm:j.xm,dh:j.dh,id:j.id};if(j.sbmc.indexOf("救护车")>-1){a.alljjry[""+j.id].jlid="1"}a.markerJjrys.push(f)})})};b();setInterval(function(){b()},"10000")},getQJJLLngLats:function(b){var a=this;$.get("getQJJLLngLats.htm",function(d){if(a.markerQjjls.length>0){a.mapObj.remove(a.markerQjjls);a.markerQjjls=[]}a.allqjjl={};var c=d.rows;$(c).each(function(f,g){if(!g.zb){return}var e=new AMap.Marker({icon:"media/image/hjz.png",position:g.zb.split(",")});e.on("click",function(k){var i="";$.get("getQJJLInfomation.htm",{qjid:g.id},function(m){var l={"0":"未接受","1":"已接受","2":"已驳回","3":"已处理","4":"已中断"};$.each(m.rows,function(n,o){if(n==0){i+="<div>参赛者："+o.xm+"("+o.dh+")</div>";i+="<div>事件名称："+o.sjmc+"</div>";i+="<div>事件描述："+o.ms+"</div>";i+="<br/>"}if(o.jjyxm){i+="<div>";i+='<a href="javascript:;" class="btn red mini" onclick="HegraceMap.cancelJjy(\''+o.jjyid+"', '"+g.id+"')\">取消</a>";i+="["+l[o.jjyzt]+"]救护员："+o.jjyxm+"("+o.jjydh+")</div>"}});i+="<br/><div>";if(b=="1"){i+=' <a href="javascript:;" class="btn green mini" onclick="HegraceMap.close(\''+g.id+"')\">完成</a>";i+=' <a href="javascript:;" class="btn red mini" onclick="HegraceMap.cancel(\''+g.id+"')\">取消</a>";i+=' <a class="btn green mini" href="javascript:;" data-toggle="dropdown">';i+=' <i class="icon-user"></i> 手工分配';i+=' <i class="icon-angle-down"></i>';i+=" </a>";i+=" <ul class=\"dropdown-menu\" style='top:100%;left:112px;margin-top:-34px;height:200px;width:100%;overflow:auto;'>";if(a.alljjry){jQuery.each(a.alljjry,function(o,n){if(n.jlid){return}i+=" <li>";i+=' <a href="javascript:;" onclick="HegraceMap.allocation(\''+n.id+"','"+g.id+'\')"><i class=" icon-user"></i> '+n.xm+"("+n.dh+")";if(n.sbmc){i+=' <br/><i class=" icon-plus-sign"></i> 设备('+n.sbmc+")"}i+=" </a></li>"})}i+=" </ul>"}i+="</div>";a.infoWindow.setContent(i);a.infoWindow.open(a.mapObj,e.getPosition())})});if(a.alljjry&&b=="1"&&false){var j=[];jQuery.each(a.alljjry,function(k,i){if(!i.jlid&&!g.jjyzt){j.push({key:k,ryid:i.ryid,jl:e.getPosition().distance(i.position)})}});j=j.sort(function(k,i){return k.jl-i.jl});j=j.slice(0,2);var h=[];jQuery.each(j,function(l,k){h.push(k.ryid)});if(h.length>0){$.ajaxSetup({async:false});$.get("automatic.htm",{ryid:h.join(","),qjid:g.id},function(){jQuery.each(j,function(l,k){a.alljjry[k.key].jlid="1"})});$.ajaxSetup({async:true})}}e.setMap(a.mapObj);e.setLabel({offset:new AMap.Pixel(30,5),content:g.xm+"("+g.dh+")"});a.allqjjl[""+g.id]={marker:e,position:e.getPosition()};a.markerQjjls.push(e)})})},getQjjlLngLatsInterval:function(b){var a=this;setInterval(function(){a.getQJJLLngLats(b)},"10000")},belaidOff:function(b){var a=this;if(confirm("真的要下岗吗？")){$.get("belaidOff.htm",{jjyid:b},function(){var c=a.alljjry[""+b].marker;a.mapObj.remove(c);delete a.alljjry[""+b];a.infoWindow&&a.infoWindow.close()})}else{return false}},close:function(b){var a=this;if(confirm("完成任务吗？")){$.get("closeQjjl.htm",{qjid:b},function(){var c=a.allqjjl[""+b].marker;a.mapObj.remove(c);delete a.allqjjl[""+b];a.infoWindow&&a.infoWindow.close()})}else{return false}},cancel:function(b){var a=this;if(confirm("取消任务吗？")){$.get("cancelQjjl.htm",{qjid:b},function(){var c=a.allqjjl[""+b].marker;a.mapObj.remove(c);delete a.allqjjl[""+b];a.infoWindow&&a.infoWindow.close()})}else{return false}},cancelJjy:function(c,b){var a=this;if(confirm("取消急救员任务吗？")){$.get("cancelSsjl.htm",{ryid:c,qjid:b},function(){a.infoWindow&&a.infoWindow.close();AMap.event.trigger(a.allqjjl[""+b].marker,"click")})}else{return false}},allocation:function(b,c){var a=this;if(confirm("确认分配吗？")){$.get("allocation.htm",{qjid:c,jjryid:b},function(){a.alljjry[""+b].jlid="1";AMap.event.trigger(a.allqjjl[""+c].marker,"click")})}else{return false}}}}();